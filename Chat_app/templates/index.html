<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat Box</title>

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding-top: 40px;
            color: #fff;
        }

        .container {
            width: 360px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            border-radius: 14px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h3 {
            text-align: center;
            margin-bottom: 15px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        input {
            width: 100%;
            padding: 10px 12px;
            margin-top: 10px;
            border-radius: 8px;
            border: none;
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            font-size: 14px;
        }

        input::placeholder {
            color: #ccc;
        }

        input:focus {
            box-shadow: 0 0 0 2px #00d4ff;
        }

        button {
            width: 100%;
            padding: 10px;
            margin-top: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            color: #fff;
            background: linear-gradient(135deg, #00d4ff, #007cf0);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 212, 255, 0.4);
        }

        button:active {
            transform: scale(0.98);
        }

        #chatBox button:first-child {
            background: linear-gradient(135deg, #ff416c, #ff4b2b);
        }

        .hidden {
            display: none;
        }

        ul {
            list-style: none;
            padding: 0;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .chat {
            display: flex;
            margin: 6px 0;
        }

        .left {
            justify-content: flex-start;
        }

        .right {
            justify-content: flex-end;
        }

        .bubble {
            max-width: 75%;
            padding: 10px 14px;
            border-radius: 14px;
            font-size: 14px;
            line-height: 1.4;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .left .bubble {
            background: rgba(255, 255, 255, 0.15);
            border-top-left-radius: 4px;
        }

        .right .bubble {
            background: linear-gradient(135deg, #00f2fe, #4facfe);
            color: #000;
            border-top-right-radius: 4px;
        }

        .sender {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 4px;
        }

        ul::-webkit-scrollbar {
            width: 6px;
        }

        ul::-webkit-scrollbar-thumb {
            background: #00d4ff;
            border-radius: 10px;
        }
    </style>
</head>

<body>

<div class="container">

    <!-- MAIN -->
    <div id="mainButtons">
        <h3>ðŸš€ Chat Box</h3>
        <button onclick="showLogin()">Login</button>
        <button onclick="showSignup()">Signup</button>
    </div>

    <!-- SIGNUP -->
    <div id="signupBox" class="hidden">
        <h3>Create Account</h3>
        <input id="su_user" placeholder="Username">
        <input id="su_pass" type="password" placeholder="Password">
        <button onclick="signup()">Register</button>
        <button onclick="back()">Back</button>
    </div>

    <!-- LOGIN -->
    <div id="loginBox" class="hidden">
        <h3>Welcome Back</h3>
        <input id="li_user" placeholder="Username">
        <input id="li_pass" type="password" placeholder="Password">
        <button onclick="login()">Login</button>
        <button onclick="back()">Back</button>
    </div>

    <!-- CHAT -->
    <div id="chatBox" class="hidden">
        <button onclick="logout()">Logout</button>
        <h3>ðŸ’¬ Global Chat</h3>

        <input id="msg" placeholder="Type your message...">
        <button onclick="sendMessage()">Send</button>

        <ul id="messages"></ul>
    </div>

</div>

<script>
let token = "";
let currentUser = "";
let messageInterval;

// UI
function showLogin() {
    mainButtons.style.display = "none";
    loginBox.classList.remove("hidden");
}

function showSignup() {
    mainButtons.style.display = "none";
    signupBox.classList.remove("hidden");
}

function back() {
    signupBox.classList.add("hidden");
    loginBox.classList.add("hidden");
    mainButtons.style.display = "block";
}

// Signup
function signup() {
    fetch("/signup", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            username: su_user.value,
            password: su_pass.value
        })
    })
    .then(res => res.json())
    .then(data => alert(data.message || data.error));
}

// Login
function login() {
    fetch("/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            username: li_user.value,
            password: li_pass.value
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.access_token) {
            token = data.access_token;
            currentUser = li_user.value;

            loginBox.classList.add("hidden");
            chatBox.classList.remove("hidden");

            loadMessages();
            messageInterval = setInterval(loadMessages, 2000);
        } else {
            alert("Invalid login");
        }
    });
}

// Send message
function sendMessage() {
    if (!msg.value.trim()) return;

    fetch("/chat", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ message: msg.value })
    }).then(() => {
        msg.value = "";
        loadMessages();
    });
}

// Load messages
function loadMessages() {
    fetch("/chat", {
        headers: {
            "Authorization": "Bearer " + token
        }
    })
    .then(res => res.json())
    .then(data => {
        messages.innerHTML = "";

        data.forEach(m => {
            let chatDiv = document.createElement("div");
            chatDiv.classList.add("chat");

            let bubble = document.createElement("div");
            bubble.classList.add("bubble");

            let sender = document.createElement("div");
            sender.classList.add("sender");

            if (m.username === currentUser) {
                chatDiv.classList.add("right");
                sender.innerText = "You";
            } else {
                chatDiv.classList.add("left");
                sender.innerText = m.username;
            }

            let text = document.createElement("div");
            text.innerText = m.message;

            bubble.appendChild(sender);
            bubble.appendChild(text);
            chatDiv.appendChild(bubble);
            messages.appendChild(chatDiv);
        });

        messages.scrollTop = messages.scrollHeight;
    });
}

// Logout
function logout() {
    token = "";
    currentUser = "";
    clearInterval(messageInterval);
    chatBox.classList.add("hidden");
    mainButtons.style.display = "block";
}
</script>

</body>
</html>
